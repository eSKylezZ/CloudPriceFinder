document.addEventListener("DOMContentLoaded",()=>{const b=document.getElementById("table-body"),S=document.getElementById("result-count"),v=document.getElementById("column-controls-btn"),g=document.getElementById("column-controls");let w=Array.from(document.querySelectorAll(".instance-row")).map(t=>JSON.parse(t.dataset.instance||"{}")),m="ipv4_ipv6",h="",f="asc";window.addEventListener("currencyChanged",t=>{const n=t,{currency:r,symbol:c,rates:o}=n.detail;document.querySelectorAll(".pricing-value[data-usd-price]").forEach(i=>{const e=parseFloat(i.getAttribute("data-usd-price")||"0");if(e>0){const s=o[r]||1,l=e*s;let a;if(["SEK","NOK","DKK"].includes(r))a=`${l.toFixed(2)} ${c}`;else if(r==="JPY")a=`${c}${Math.round(l)}`;else{const u=i.closest(".pricing-hourly")?4:2;a=`${c}${l.toFixed(u)}`}i.textContent=a}})}),v&&g&&(v.addEventListener("click",()=>{g.classList.toggle("hidden")}),document.addEventListener("click",t=>{!v.contains(t.target)&&!g.contains(t.target)&&g.classList.add("hidden")})),document.querySelectorAll('#column-controls input[type="checkbox"]').forEach(t=>{t.addEventListener("change",n=>{const r=n.target,c=r.id.replace("col-","col-"),o=r.checked;document.querySelectorAll(`.${c}`).forEach(e=>{o?e.classList.remove("hidden"):e.classList.add("hidden")})})}),document.querySelectorAll("th[data-sort]").forEach(t=>{t.addEventListener("click",()=>{const n=t.getAttribute("data-sort");n&&(h===n?f=f==="asc"?"desc":"asc":f="asc",h=n,L(n,f),E())})});function x(){document.querySelectorAll(".regions-more-trigger").forEach(t=>{const n=t.querySelector(".all-regions-popup");if(!n)return;let r,c;t.addEventListener("mouseenter",()=>{clearTimeout(c),r=setTimeout(()=>{n.classList.remove("invisible")},200)}),t.addEventListener("mouseleave",()=>{clearTimeout(r),c=setTimeout(()=>{n.classList.add("invisible")},300)}),n.addEventListener("mouseenter",()=>{clearTimeout(c)}),n.addEventListener("mouseleave",()=>{c=setTimeout(()=>{n.classList.add("invisible")},300)})})}x(),document.addEventListener("filtersChanged",t=>{const r=t.detail;r.networkOptions?.length===1?m=r.networkOptions[0]:m="ipv4_ipv6",N(r),r.regions?.length&&k(r.regions)});function E(){if(document.querySelectorAll(".sort-icon").forEach(n=>{n.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>',n.classList.remove("text-primary-600"),n.classList.add("text-gray-400")}),h){const n=document.querySelector(`th[data-sort="${h}"] .sort-icon`);n&&(n.classList.remove("text-gray-400"),n.classList.add("text-primary-600"),f==="asc"?n.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4l6 6 6-6"></path>':n.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 16l-6-6-6 6"></path>')}}function L(t,n){const c=Array.from(document.querySelectorAll(".instance-row:not(.hidden)")).map(o=>JSON.parse(o.dataset.instance||"{}"));c.sort((o,i)=>{let e=o[t],s=i[t];if(t.includes(".")){const u=t.split(".");e=u.reduce((d,y)=>d?.[y],o),s=u.reduce((d,y)=>d?.[y],i)}if(e==null&&s==null)return 0;if(e==null)return n==="asc"?1:-1;if(s==null)return n==="asc"?-1:1;if(typeof e=="string"&&typeof s=="string"){const u=e.localeCompare(s);return n==="asc"?u:-u}const l=Number(e),a=Number(s);if(!isNaN(l)&&!isNaN(a))return n==="asc"?l-a:a-l;const p=String(e).localeCompare(String(s));return n==="asc"?p:-p}),C(c)}function k(t){document.querySelectorAll(".regions-container").forEach(r=>{const c=JSON.parse(r.getAttribute("data-regions")||"[]");if(!c.length)return;const o=[...c].sort((i,e)=>{const s=t.some(a=>a===i.country||a===i.code||a===i.region),l=t.some(a=>a===e.country||a===e.code||a===e.region);return s&&!l?-1:!s&&l?1:0});_(r,o)}),x()}function _(t,n){t.innerHTML="";const c=n.slice(0,3),o=Math.max(0,n.length-3);if(c.forEach(i=>{const e=document.createElement("div");e.className="relative group",e.innerHTML=`
          <span class="inline-flex items-center space-x-1 cursor-pointer hover:bg-gray-100 px-1 py-0.5 rounded">
            <img 
              src="https://flagsapi.com/${i.countryCode}/flat/16.png"
              alt="${i.country}"
              class="w-4 h-3 rounded-sm"
              loading="lazy"
            />
            <span class="text-xs">${i.code}</span>
          </span>
          <div class="absolute z-20 invisible group-hover:visible bg-gray-900 text-white text-xs px-2 py-1 rounded shadow-lg bottom-full left-1/2 transform -translate-x-1/2 mb-1 whitespace-nowrap">
            <div class="font-medium">${i.city}, ${i.country}</div>
            <div class="text-gray-300">${i.region}</div>
            <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"></div>
          </div>
        `,t.appendChild(e)}),o>0){const i=document.createElement("div");i.className="relative group cursor-pointer";const e=n.map(s=>`
          <div class="flex items-center space-x-2 py-1">
            <img 
              src="https://flagsapi.com/${s.countryCode}/flat/16.png"
              alt="${s.country}"
              class="w-4 h-3 rounded-sm flex-shrink-0"
              loading="lazy"
            />
            <div class="flex-1 min-w-0">
              <div class="text-xs font-medium text-gray-900 truncate">${s.city}, ${s.country}</div>
              <div class="text-xs text-gray-500 truncate">${s.code} â€¢ ${s.region}</div>
            </div>
          </div>
        `).join("");i.innerHTML=`
          <span class="text-xs text-gray-400 hover:text-gray-600">+${o}</span>
          <div class="all-regions-popup absolute z-30 invisible bg-white border border-gray-200 rounded-lg shadow-lg p-3 bottom-full right-0 mb-2 w-64">
            <div class="text-xs font-medium text-gray-900 mb-2">All Available Regions:</div>
            <div class="grid grid-cols-1 gap-1 max-h-40 overflow-y-auto">
              ${e}
            </div>
            <div class="absolute top-full right-4 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-200"></div>
          </div>
        `,i.className="relative regions-more-trigger cursor-pointer",t.appendChild(i)}}function N(t){const n=w.filter(r=>{if(t.providers?.length&&!t.providers.includes(r.provider))return!1;if(t.regions?.length){let o=!1;if(r.regionalPricing&&Array.isArray(r.regionalPricing)){const i=[];r.locationDetails&&Array.isArray(r.locationDetails)&&i.push(...r.locationDetails.filter(e=>t.regions.some(s=>s===e.country||s===e.code||s===e.region||s===e.city||s.toLowerCase()===e.country.toLowerCase()||s.toLowerCase()===e.code.toLowerCase()))),o=i.length>0&&i.some(e=>r.regionalPricing.some(s=>s.location===e.code))}else r.locationDetails&&Array.isArray(r.locationDetails)?o=r.locationDetails.some(i=>t.regions.some(e=>e===i.country||e===i.code||e===i.region||e===i.city||e.toLowerCase()===i.country.toLowerCase()||e.toLowerCase()===i.code.toLowerCase())):r.regions&&Array.isArray(r.regions)&&(o=r.regions.some(i=>t.regions.some(e=>e===i||e.toLowerCase()===i.toLowerCase())));if(!o)return!1}if(t.instanceTypes?.length&&!t.instanceTypes.includes(r.type))return!1;if(t.ipTypes?.length){const o=r.networkType||r.ipType;if(o&&!t.ipTypes.includes(o))return!1}if(t.networkOptions?.length){const o=r.networkType||r.networkOptions;if(o&&typeof o=="object"){if(!t.networkOptions.some(e=>o[e]&&o[e].available))return!1}else if(o&&typeof o=="string"&&!t.networkOptions.includes(o))return!1}if(r.vCPU<t.minVCPU||r.vCPU>t.maxVCPU||r.memoryGiB<t.minMemory||r.memoryGiB>t.maxMemory)return!1;let c=0;if(t.regions?.length===1&&r.regionalPricing&&r.locationDetails){const o=t.regions[0],i=r.locationDetails.find(e=>o===e.country||o===e.code||o.toLowerCase()===e.country.toLowerCase()||o.toLowerCase()===e.code.toLowerCase());if(i){const e=r.regionalPricing.find(s=>s.location===i.code);e&&e.hourly_net&&(c=e.hourly_net)}}if(c===0){if(r.networkOptions&&typeof r.networkOptions=="object"){const o=r.networkOptions[m];o&&o.available&&o.hourly!==null&&(c=o.hourly)}c===0&&(c=r.priceUSD_hourly||r.priceEUR_hourly_net||0)}return r.type==="cloud-server"&&r.instanceType==="cx22"&&console.log("  Final price to check:",c,"vs max price:",t.maxPrice),c>t.maxPrice?(r.type==="cloud-server"&&r.instanceType==="cx22"&&console.log("  FAILED price filter. Price:",c,"Max:",t.maxPrice),!1):(r.type==="cloud-server"&&r.instanceType==="cx22"&&console.log("  PASSED ALL FILTERS! ðŸŽ‰"),!0)});console.log(`Filtered result: ${n.length} instances`),console.log("Filtered examples:",n.slice(0,5).map(r=>({instanceType:r.instanceType,type:r.type}))),C(n),t.regions?.length===1?F(t.regions[0]):T(),S&&(S.textContent=`${n.length} instances`)}function F(t){document.querySelectorAll(".instance-row:not(.hidden)").forEach(n=>{const r=JSON.parse(n.dataset.instance||"{}");if(!r.locationDetails||!r.regionalPricing)return;const c=r.locationDetails.find(o=>t===o.country||t===o.code||t.toLowerCase()===o.country.toLowerCase()||t.toLowerCase()===o.code.toLowerCase());if(c){const o=r.regionalPricing.find(i=>i.location===c.code);if(o){const i=r.hetzner_metadata?.ipv4_primary_ip_cost||.5;let e=o.hourly_net,s=o.monthly_net;m==="ipv4_ipv6"&&(e+=i/730.44,s+=i);const l=n.querySelector(".pricing-hourly .pricing-value");l&&(l.textContent=new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR",minimumFractionDigits:4}).format(e));const a=n.querySelector(".pricing-monthly .pricing-value");a&&(a.textContent=new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR",minimumFractionDigits:2}).format(s));const p=n.querySelector('[data-network-info="true"]');if(p){const u=p.querySelector(".pricing-description");if(u){const d=m==="ipv4_ipv6"?"pricing (incl. IPv4)":"pricing";u.textContent=`${c.city} ${d}`,u.className="text-xs text-blue-600 pricing-description"}}if(o.included_traffic||o.traffic_price_per_tb){const u=document.createElement("div");u.className="text-xs text-gray-500 mt-1";let d="";if(o.included_traffic){const y=(o.included_traffic/1099511627776).toFixed(1);d+=`${y}TB included`}if(o.traffic_price_per_tb&&(d&&(d+=", "),d+=`â‚¬${o.traffic_price_per_tb}/TB overage`),d){u.textContent=d;const y=n.querySelector(".pricing-hourly");y&&!y.querySelector(".traffic-info")&&(u.classList.add("traffic-info"),y.appendChild(u))}}}}})}function T(){document.querySelectorAll(".instance-row:not(.hidden)").forEach(t=>{const n=JSON.parse(t.dataset.instance||"{}");t.querySelectorAll(".traffic-info").forEach(e=>e.remove());const c=t.querySelector(".pricing-hourly .pricing-value");if(c){const e=n.priceEUR_hourly_net||n.priceUSD_hourly||0,s=n.priceEUR_hourly_net?"EUR":"USD";c.textContent=new Intl.NumberFormat("en-US",{style:"currency",currency:s,minimumFractionDigits:4}).format(e)}const o=t.querySelector(".pricing-monthly .pricing-value");if(o){const e=n.priceEUR_monthly_net||n.priceUSD_monthly||0,s=n.priceEUR_monthly_net?"EUR":"USD";o.textContent=new Intl.NumberFormat("en-US",{style:"currency",currency:s,minimumFractionDigits:2}).format(e)}const i=t.querySelector('[data-network-info="true"]');if(i){const e=i.querySelector(".pricing-description");e&&(e.textContent="Standard pricing",e.className="text-xs text-gray-500 pricing-description")}})}function q(){document.querySelectorAll('.instance-row:not([style*="display: none"])').forEach(t=>{const n=JSON.parse(t.dataset.instance||"{}");t.querySelector('[data-network-info="true"]');const r=t.querySelector(".pricing-mode-indicator"),c=t.querySelector(".pricing-description"),o=t.querySelector(".pricing-hourly"),i=t.querySelector(".pricing-monthly");if(n.networkOptions&&typeof n.networkOptions=="object"){const e=n.networkOptions[m];if(e&&e.available){if(r&&(r.textContent=m==="ipv6_only"?"IPv6-only":"IPv4 + IPv6",r.className=`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium pricing-mode-indicator ${m==="ipv6_only"?"bg-green-100 text-green-800":"bg-cyan-100 text-cyan-800"}`),c&&(m==="ipv6_only"&&e.savings?(c.textContent=`Saves â‚¬${e.savings.toFixed(2)}/month`,c.className="text-xs text-green-600 pricing-description"):(c.textContent=e.description||"Standard pricing",c.className="text-xs text-gray-500 pricing-description")),o&&e.hourly!==null){const s=o.querySelector(".pricing-value"),l=o.querySelector(".text-xs.text-orange-600");if(s){const a=e.priceRange?.hourly;if(a&&a.hasVariation){const p=new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR",minimumFractionDigits:4}).format(a.min),u=new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR",minimumFractionDigits:4}).format(a.max);s.textContent=`${p} - ${u}`,l&&(l.style.display="")}else s.textContent=new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR",minimumFractionDigits:4}).format(e.hourly),l&&(l.style.display="none")}}if(i&&e.monthly!==null){const s=i.querySelector(".pricing-value"),l=i.querySelector(".text-xs.text-orange-600");if(s){const a=e.priceRange?.monthly;if(a&&a.hasVariation){const p=new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR",minimumFractionDigits:2}).format(a.min),u=new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR",minimumFractionDigits:2}).format(a.max);s.textContent=`${p} - ${u}`,l&&(l.style.display="")}else s.textContent=new Intl.NumberFormat("en-US",{style:"currency",currency:"EUR",minimumFractionDigits:2}).format(e.monthly),l&&(l.style.display="none")}}t.style.display=""}else m!=="all"&&m!=="ipv4_ipv6"&&(t.style.display="none")}})}function C(t){b&&(document.querySelectorAll(".instance-row").forEach(n=>{n.style.display="none"}),t.forEach(n=>{const r=Array.from(document.querySelectorAll(".instance-row")).find(c=>{const o=JSON.parse(c.dataset.instance||"{}");return o.instanceType===n.instanceType&&o.provider===n.provider});r&&(r.style.display="",b.appendChild(r))}),q(),x())}});
