document.addEventListener("DOMContentLoaded",()=>{const L=document.getElementById("table-body"),E=document.getElementById("result-count"),C=document.getElementById("column-controls-btn"),v=document.getElementById("column-controls");let $=Array.from(document.querySelectorAll(".instance-row")).map(e=>JSON.parse(e.dataset.instance||"{}")),p="ipv4_ipv6",x="",h="asc",g=localStorage.getItem("selectedCurrency")||"USD",S={USD:1};window.addEventListener("currencyChanged",e=>{const o=e,{currency:n,symbol:s,rates:r}=o.detail;g=n,S=r,document.querySelectorAll(".pricing-value[data-usd-price]").forEach(i=>{const t=parseFloat(i.getAttribute("data-usd-price")||"0");if(t>0){const c=r[n]||1,l=t*c;let a;if(["SEK","NOK","DKK"].includes(n))a=`${l.toFixed(2)} ${s}`;else if(n==="JPY")a=`${s}${Math.round(l)}`;else{const d=i.closest(".pricing-hourly")?4:2;a=`${s}${l.toFixed(d)}`}i.textContent=a}})});function b(e,o=!1){if(!e||e===0)return"-";const s={USD:"$",EUR:"â‚¬",GBP:"Â£",SEK:"kr",NOK:"kr",DKK:"kr",CHF:"Fr",CAD:"$",AUD:"$",JPY:"Â¥"}[g]||g,r=S[g]||1,i=e*r;if(["SEK","NOK","DKK"].includes(g)){const t=o?4:2;return`${i.toFixed(t)} ${s}`}else{if(g==="JPY")return`${s}${Math.round(i)}`;{const t=o?4:2;return`${s}${i.toFixed(t)}`}}}function y(e,o=!1){if(!e||e===0)return"-";const n=S.EUR||.92,s=e/n;return b(s,o)}C&&v&&(C.addEventListener("click",()=>{v.classList.toggle("hidden")}),document.addEventListener("click",e=>{!C.contains(e.target)&&!v.contains(e.target)&&v.classList.add("hidden")})),document.querySelectorAll('#column-controls input[type="checkbox"]').forEach(e=>{e.addEventListener("change",o=>{const n=o.target,s=n.id.replace("col-","col-"),r=n.checked;document.querySelectorAll(`.${s}`).forEach(t=>{r?t.classList.remove("hidden"):t.classList.add("hidden")})})}),document.querySelectorAll("th[data-sort]").forEach(e=>{e.addEventListener("click",()=>{const o=e.getAttribute("data-sort");o&&(x===o?h=h==="asc"?"desc":"asc":h="asc",x=o,T(o,h),P())})});function w(){document.querySelectorAll(".regions-more-trigger").forEach(e=>{const o=e.querySelector(".all-regions-popup");if(!o)return;let n,s;e.addEventListener("mouseenter",()=>{clearTimeout(s),n=setTimeout(()=>{o.classList.remove("invisible")},200)}),e.addEventListener("mouseleave",()=>{clearTimeout(n),s=setTimeout(()=>{o.classList.add("invisible")},300)}),o.addEventListener("mouseenter",()=>{clearTimeout(s)}),o.addEventListener("mouseleave",()=>{s=setTimeout(()=>{o.classList.add("invisible")},300)})})}w(),document.addEventListener("filtersChanged",e=>{const n=e.detail;n.networkOptions?.length===1?p=n.networkOptions[0]:p="ipv4_ipv6",_(n),n.regions?.length&&A(n.regions)});function P(){if(document.querySelectorAll(".sort-icon").forEach(o=>{o.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>',o.classList.remove("text-primary-600"),o.classList.add("text-gray-400")}),x){const o=document.querySelector(`th[data-sort="${x}"] .sort-icon`);o&&(o.classList.remove("text-gray-400"),o.classList.add("text-primary-600"),h==="asc"?o.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4l6 6 6-6"></path>':o.innerHTML='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 16l-6-6-6 6"></path>')}}function T(e,o){const s=Array.from(document.querySelectorAll(".instance-row:not(.hidden)")).map(r=>JSON.parse(r.dataset.instance||"{}"));s.sort((r,i)=>{let t=r[e],c=i[e];if(e.includes(".")){const d=e.split(".");t=d.reduce((u,f)=>u?.[f],r),c=d.reduce((u,f)=>u?.[f],i)}if(t==null&&c==null)return 0;if(t==null)return o==="asc"?1:-1;if(c==null)return o==="asc"?-1:1;if(typeof t=="string"&&typeof c=="string"){const d=t.localeCompare(c);return o==="asc"?d:-d}const l=Number(t),a=Number(c);if(!isNaN(l)&&!isNaN(a))return o==="asc"?l-a:a-l;const m=String(t).localeCompare(String(c));return o==="asc"?m:-m}),k(s)}function A(e){document.querySelectorAll(".regions-container").forEach(n=>{const s=JSON.parse(n.getAttribute("data-regions")||"[]");if(!s.length)return;const r=[...s].sort((i,t)=>{const c=e.some(a=>a===i.country||a===i.code||a===i.region),l=e.some(a=>a===t.country||a===t.code||a===t.region);return c&&!l?-1:!c&&l?1:0});q(n,r)}),w()}function q(e,o){e.innerHTML="";const s=o.slice(0,3),r=Math.max(0,o.length-3);if(s.forEach(i=>{const t=document.createElement("div");t.className="relative group",t.innerHTML=`
          <span class="inline-flex items-center space-x-1 cursor-pointer hover:bg-gray-100 px-1 py-0.5 rounded">
            <img 
              src="https://flagsapi.com/${i.countryCode}/flat/16.png"
              alt="${i.country}"
              class="w-4 h-3 rounded-sm"
              loading="lazy"
            />
            <span class="text-xs">${i.code}</span>
          </span>
          <div class="absolute z-20 invisible group-hover:visible bg-gray-900 text-white text-xs px-2 py-1 rounded shadow-lg bottom-full left-1/2 transform -translate-x-1/2 mb-1 whitespace-nowrap">
            <div class="font-medium">${i.city}, ${i.country}</div>
            <div class="text-gray-300">${i.region}</div>
            <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"></div>
          </div>
        `,e.appendChild(t)}),r>0){const i=document.createElement("div");i.className="relative group cursor-pointer";const t=o.map(c=>`
          <div class="flex items-center space-x-2 py-1">
            <img 
              src="https://flagsapi.com/${c.countryCode}/flat/16.png"
              alt="${c.country}"
              class="w-4 h-3 rounded-sm flex-shrink-0"
              loading="lazy"
            />
            <div class="flex-1 min-w-0">
              <div class="text-xs font-medium text-gray-900 truncate">${c.city}, ${c.country}</div>
              <div class="text-xs text-gray-500 truncate">${c.code} â€¢ ${c.region}</div>
            </div>
          </div>
        `).join("");i.innerHTML=`
          <span class="text-xs text-gray-400 hover:text-gray-600">+${r}</span>
          <div class="all-regions-popup absolute z-30 invisible bg-white border border-gray-200 rounded-lg shadow-lg p-3 bottom-full right-0 mb-2 w-64">
            <div class="text-xs font-medium text-gray-900 mb-2">All Available Regions:</div>
            <div class="grid grid-cols-1 gap-1 max-h-40 overflow-y-auto">
              ${t}
            </div>
            <div class="absolute top-full right-4 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-200"></div>
          </div>
        `,i.className="relative regions-more-trigger cursor-pointer",e.appendChild(i)}}function _(e){const o=$.filter(n=>{if(e.providers?.length&&!e.providers.includes(n.provider))return!1;if(e.regions?.length){let r=!1;if(n.regionalPricing&&Array.isArray(n.regionalPricing)){const i=[];n.locationDetails&&Array.isArray(n.locationDetails)&&i.push(...n.locationDetails.filter(t=>e.regions.some(c=>c===t.country||c===t.code||c===t.region||c===t.city||c.toLowerCase()===t.country.toLowerCase()||c.toLowerCase()===t.code.toLowerCase()))),r=i.length>0&&i.some(t=>n.regionalPricing.some(c=>c.location===t.code))}else n.locationDetails&&Array.isArray(n.locationDetails)?r=n.locationDetails.some(i=>e.regions.some(t=>t===i.country||t===i.code||t===i.region||t===i.city||t.toLowerCase()===i.country.toLowerCase()||t.toLowerCase()===i.code.toLowerCase())):n.regions&&Array.isArray(n.regions)&&(r=n.regions.some(i=>e.regions.some(t=>t===i||t.toLowerCase()===i.toLowerCase())));if(!r)return!1}if(e.instanceTypes?.length&&!e.instanceTypes.includes(n.type))return!1;if(e.ipTypes?.length){const r=n.networkType||n.ipType;if(r&&!e.ipTypes.includes(r))return!1}if(e.networkOptions?.length){const r=n.networkType||n.networkOptions;if(r&&typeof r=="object"){if(!e.networkOptions.some(t=>r[t]&&r[t].available))return!1}else if(r&&typeof r=="string"&&!e.networkOptions.includes(r))return!1}if(n.vCPU<e.minVCPU||n.vCPU>e.maxVCPU||n.memoryGiB<e.minMemory||n.memoryGiB>e.maxMemory)return!1;let s=0;if(e.regions?.length===1&&n.regionalPricing&&n.locationDetails){const r=e.regions[0],i=n.locationDetails.find(t=>r===t.country||r===t.code||r.toLowerCase()===t.country.toLowerCase()||r.toLowerCase()===t.code.toLowerCase());if(i){const t=n.regionalPricing.find(c=>c.location===i.code);t&&t.hourly_net&&(s=t.hourly_net)}}if(s===0){if(n.networkOptions&&typeof n.networkOptions=="object"){const r=n.networkOptions[p];r&&r.available&&r.hourly!==null&&(s=r.hourly)}s===0&&(s=n.priceUSD_hourly||n.priceEUR_hourly_net||0)}return n.type==="cloud-server"&&n.instanceType==="cx22"&&console.log("  Final price to check:",s,"vs max price:",e.maxPrice),s>e.maxPrice?(n.type==="cloud-server"&&n.instanceType==="cx22"&&console.log("  FAILED price filter. Price:",s,"Max:",e.maxPrice),!1):(n.type==="cloud-server"&&n.instanceType==="cx22"&&console.log("  PASSED ALL FILTERS! ðŸŽ‰"),!0)});console.log(`Filtered result: ${o.length} instances`),console.log("Filtered examples:",o.slice(0,5).map(n=>({instanceType:n.instanceType,type:n.type}))),k(o),e.regions?.length===1?D(e.regions[0]):N(),E&&(E.textContent=`${o.length} instances`)}function D(e){document.querySelectorAll(".instance-row:not(.hidden)").forEach(o=>{const n=JSON.parse(o.dataset.instance||"{}");if(!n.locationDetails||!n.regionalPricing)return;const s=n.locationDetails.find(r=>e===r.country||e===r.code||e.toLowerCase()===r.country.toLowerCase()||e.toLowerCase()===r.code.toLowerCase());if(s){const r=n.regionalPricing.find(i=>i.location===s.code);if(r){const i=n.hetzner_metadata?.ipv4_primary_ip_cost||.5;let t=r.hourly_net,c=r.monthly_net;p==="ipv4_ipv6"&&(t+=i/730.44,c+=i);const l=o.querySelector(".pricing-hourly .pricing-value");l&&(l.textContent=y(t,!0));const a=o.querySelector(".pricing-monthly .pricing-value");a&&(a.textContent=y(c,!1));const m=o.querySelector('[data-network-info="true"]');if(m){const d=m.querySelector(".pricing-description");if(d){const u=p==="ipv4_ipv6"?"pricing (incl. IPv4)":"pricing";d.textContent=`${s.city} ${u}`,d.className="text-xs text-blue-600 pricing-description"}}if(r.included_traffic||r.traffic_price_per_tb){const d=document.createElement("div");d.className="text-xs text-gray-500 mt-1";let u="";if(r.included_traffic){const f=(r.included_traffic/1099511627776).toFixed(1);u+=`${f}TB included`}if(r.traffic_price_per_tb&&(u&&(u+=", "),u+=`â‚¬${r.traffic_price_per_tb}/TB overage`),u){d.textContent=u;const f=o.querySelector(".pricing-hourly");f&&!f.querySelector(".traffic-info")&&(d.classList.add("traffic-info"),f.appendChild(d))}}}}})}function N(){document.querySelectorAll(".instance-row:not(.hidden)").forEach(e=>{const o=JSON.parse(e.dataset.instance||"{}");e.querySelectorAll(".traffic-info").forEach(t=>t.remove());const s=e.querySelector(".pricing-hourly .pricing-value");if(s){const t=o.priceEUR_hourly_net,c=o.priceUSD_hourly;t?s.textContent=y(t,!0):c?s.textContent=b(c,!0):s.textContent="-"}const r=e.querySelector(".pricing-monthly .pricing-value");if(r){const t=o.priceEUR_monthly_net,c=o.priceUSD_monthly;t?r.textContent=y(t,!1):c?r.textContent=b(c,!1):r.textContent="-"}const i=e.querySelector('[data-network-info="true"]');if(i){const t=i.querySelector(".pricing-description");t&&(t.textContent="Standard pricing",t.className="text-xs text-gray-500 pricing-description")}})}function I(){document.querySelectorAll('.instance-row:not([style*="display: none"])').forEach(e=>{const o=JSON.parse(e.dataset.instance||"{}");e.querySelector('[data-network-info="true"]');const n=e.querySelector(".pricing-mode-indicator"),s=e.querySelector(".pricing-description"),r=e.querySelector(".pricing-hourly"),i=e.querySelector(".pricing-monthly");if(o.networkOptions&&typeof o.networkOptions=="object"){const t=o.networkOptions[p];if(t&&t.available){if(n&&(n.textContent=p==="ipv6_only"?"IPv6-only":"IPv4 + IPv6",n.className=`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium pricing-mode-indicator ${p==="ipv6_only"?"bg-green-100 text-green-800":"bg-cyan-100 text-cyan-800"}`),s&&(p==="ipv6_only"&&t.savings?(s.textContent=`Saves â‚¬${t.savings.toFixed(2)}/month`,s.className="text-xs text-green-600 pricing-description"):(s.textContent=t.description||"Standard pricing",s.className="text-xs text-gray-500 pricing-description")),r&&t.hourly!==null){const c=r.querySelector(".pricing-value"),l=r.querySelector(".text-xs.text-orange-600");if(c){const a=t.priceRange?.hourly;if(a&&a.hasVariation){const m=y(a.min,!0),d=y(a.max,!0);c.textContent=`${m} - ${d}`,l&&(l.style.display="")}else c.textContent=y(t.hourly,!0),l&&(l.style.display="none")}}if(i&&t.monthly!==null){const c=i.querySelector(".pricing-value"),l=i.querySelector(".text-xs.text-orange-600");if(c){const a=t.priceRange?.monthly;if(a&&a.hasVariation){const m=y(a.min,!1),d=y(a.max,!1);c.textContent=`${m} - ${d}`,l&&(l.style.display="")}else c.textContent=y(t.monthly,!1),l&&(l.style.display="none")}}e.style.display=""}else p!=="all"&&p!=="ipv4_ipv6"&&(e.style.display="none")}})}function k(e){L&&(document.querySelectorAll(".instance-row").forEach(o=>{o.style.display="none"}),e.forEach(o=>{const n=Array.from(document.querySelectorAll(".instance-row")).find(s=>{const r=JSON.parse(s.dataset.instance||"{}");return r.instanceType===o.instanceType&&r.provider===o.provider});n&&(n.style.display="",L.appendChild(n))}),I(),w())}setTimeout(()=>{const e=new CustomEvent("requestCurrencyData");window.dispatchEvent(e)},100)});
